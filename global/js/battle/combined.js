function find_distance(a){var b=$(a).parent().css("left"),c=$(a).parent().css("top");return{x:parseInt(b.substring(0,b.length-2)),y:parseInt(c.substring(0,c.length-2))}}var animate={animation_busy:false,queue:[],animation_interval:{},animation_data_cache:{},run_queue:function(){if(animate.queue.length>0){animate.process(animate.queue[0]);animate.queue.splice(0,1)}else{console.log("Queue is empty.");return true}},process:function(b){var f=0;var g=$(b.selector);var e=$(b.selector).parent();if(typeof animate.animation_interval[b.selector]!="undefined"){clearInterval(animate.animation_interval[b.selector])}if(typeof animate.animation_data_cache[b.selector]!="undefined"){b=$.extend({tile_x:animate.animation_data_cache[b.selector]["tile_x"],tile_y:animate.animation_data_cache[b.selector]["tile_y"],img_width:animate.animation_data_cache[b.selector]["img_width"],animation:animate.animation_data_cache[b.selector]["animation"],queue:false,time:animate.animation_data_cache[b.selector]["time"],loop:false,},b);f=1}else{b=$.extend({tile_x:parseInt(g.width()),tile_y:parseInt(g.height()),animation:1,queue:false,time:1000,loop:false,},b);animate.animation_data_cache[b.selector]=b}if(animate.animation_busy==true&&b.queue==true){console.log("Pushing "+b.selector+" to the queue");animate.queue.push(b);return false}if(typeof b.onload!="undefined"){b.onload()}if(typeof b.message!="undefined"){this.events.dialog(b.message)}var c=document.getElementById(b.selector.substring(1)).style;animate.animation_interval[b.selector]=setInterval(function(){if(f>Math.round(b.img_width/b.tile_x)){f=1}c.backgroundPosition="-"+(f*b.tile_x)+"px -"+(b.animation*b.tile_y)+"px";f++},(Math.round(b.time/Math.round(b.img_width/b.tile_x))));if(typeof b.move_x!="undefined"&&typeof b.move_y=="undefined"){e.animate({left:b.move_x+"px"},b.time,"linear")}else{if(typeof b.move_x!="undefined"&&typeof b.move_y=="undefined"){e.parent().animate({top:b.move_y+"px"},b.time,"linear")}else{if(typeof b.move_x!="undefined"&&typeof b.move_y!="undefined"){var a=e.position();if(a.left>b.move_x){var d={start:{x:a.left,y:a.top,angle:13,length:0.5},end:{x:b.move_x,y:b.move_y}}}else{var d={start:{x:a.left,y:a.top,angle:-13,length:0.5},end:{x:b.move_x,y:b.move_y}}}e.animate({top:a.top-2+"px"},150,"linear").animate({path:new $.path.bezier(d)},(b.time/1.5))}}}if(b.loop===false){animate.animation_busy=true;setTimeout(function(){animate.animation_busy=false;clearInterval(animate.animation_interval[b.selector]);if(typeof b.callback!="undefined"){b.callback()}},b.time)}},character:{idle:function(a){animate.process({img_width:720,animation:2,selector:a,time:2400,loop:true})},cheer:function(a){animate.process({img_width:720,animation:4,selector:a,time:1600})},faint:function(a){animate.process({img_width:720,animation:5,selector:a,time:2000,callback:function(){$(a).animate({opacity:0.4},500)}})},block:function(a){animate.process({img_width:720,animation:1,selector:"#player_sprite",time:1000,queue:false,callback:function(){animate.character.idle(a)}})},},coin_burst:function(g,d){var b=$("#gold_hive");var a=$(g).offset();var f=$("#jackpot").offset();var c=0;while(c<d){b.append('<img src="/images/flying_coin.gif" alt="" id="coinjp_'+c+'" style="left:'+(parseInt(a.left)+25)+"; top:"+(parseInt(a.top)+60)+'; " class="flying_coin" />');var e={start:{x:(parseInt(a.left)+25),y:(parseInt(a.top)+60),angle:rand(0,90),length:rand(-2,2)},end:{x:(parseInt(f.left)+15),y:(parseInt(f.top)+15)}};$("#coinjp_"+c+"").animate({path:new $.path.bezier(e),opacity:0.2},900,function(){$(this).remove()});c++}setTimeout(function(){$("#jackpot h3").increase(d,true)},600)},exp_burst:function(h,a,e){var c=$("#misc_hive");var b=$(h).offset();var g=$(a).offset();var d=0;while(d<e){c.append('<img src="/images/exp_orb_'+rand(1,3)+'.png" alt="" id="expjp_'+d+'" style="left:'+(parseInt(b.left)+25)+"; top:"+(parseInt(b.top)+60)+'; " class="flying_coin" />');var f={start:{x:(parseInt(b.left)+25),y:(parseInt(b.top)+60),angle:rand(-80,80),length:rand(-1,1)},end:{x:(parseInt(g.left)+30),y:(parseInt(g.top)+50)}};$("#expjp_"+d+"").animate({path:new $.path.bezier(f),opacity:0.05},700,function(){$(this).remove()});d++}},events:{dialog:function(a){clearTimeout(this.dialog_fadeout);$("#battle_queue_dialog").stop().text(a).fadeTo(200,1,function(){this.dialog_fadeout=setTimeout(function(){$("#battle_queue_dialog").fadeTo(1000,0)},1500)})},battle_checks:function(a){if(typeof a.exp_bonus!="undefined"||typeof a.exp_animation!="undefined"){animate.exp_burst("#monster_"+a.monster_defeated+"_sprite","#player_sprite",a.exp_bonus);setTimeout(function(){if(typeof a.exp_animation!="undefined"){console.log(a.exp_animation);var c=0;for(var d=0;d<a.exp_animation.length;d++){setTimeout(function(){var g=c;if(a.exp_animation[g]["from_level"]<a.exp_animation[g]["to_level"]){var f="exp"+rand(1,1000000);$("#misc_hive").after('<strong class="exp_points" id="'+f+'" style="opacity:0;">+'+a.exp_animation[g]["exp_bonus"]+"</strong>");$("#current_exp").increase(a.exp_animation[g]["exp_bonus"]);var e=$(".experience_bar").offset();$("#"+f).css({left:e.left+100,top:e.top-20,fontSize:"24px"});$("#"+f).animate({opacity:1,fontSize:"20px",top:"+=15"},300,"linear",function(){var h=$("#"+f);setTimeout(function(){h.animate({opacity:0},500,"linear",function(){h.remove()})},1000)});$(".experience_bar div").animate({width:"100%"},800,function(){$("#level_up_shine").fadeIn(800,function(){setTimeout(function(){$("#level_up_shine").fadeOut(400)},1000)});animate.character.cheer("#player_sprite");setTimeout(function(){animate.character.idle("#player_sprite")},1200);var i="animation"+rand(1,1000000);var j=$(".player_container").offset();var h='<div id="front_glitter_'+i+'"></div>';h+='<div id="back_portal_'+i+'"></div>';h+='<div id="front_header_'+i+'"></div>';$("#animation_hive").append(h);$("#front_header_"+i).css({position:"absolute",left:j.left-20,top:j.top+20,width:120,height:120,background:"transparent url(/images/animations/levelup_header.png)no-repeat 3px -40px",zIndex:15,opacity:0});$("#front_glitter_"+i).css({position:"absolute",left:j.left-20,top:j.top+30,width:120,height:120,background:"transparent url(/images/animations/star_animations.gif)no-repeat 3px -40px",zIndex:14,opacity:0,});$("#back_portal_"+i).css({position:"absolute",left:j.left-20,top:j.top-10,width:120,height:120,background:"transparent url(/images/animations/level_up_portal_back.png)no-repeat 3px -5px",zIndex:5,opacity:0,});setTimeout(function(){$("#front_header_"+i).animate({opacity:1,top:"-=35"},1000);$("#back_portal_"+i).animate({opacity:1},300,function(){$("#front_glitter_"+i).animate({opacity:1},600,function(){setTimeout(function(){$("#front_glitter_"+i+", #front_header_"+i).animate({opacity:0},800,function(){$(this).remove();$("#back_portal_"+i).fadeOut(1000,function(){$(this).remove()})})},500)})})},300);battle.increase_hp("#player_sprite",a.exp_animation[g]["heal_points"]);$(".experience_bar div").width(0);$("#level_bubble").text(a.exp_animation[g]["to_level"]);$("#next_level_exp").text(a.exp_animation[g]["new_exp_required"]).attr("data_amount",a.exp_animation[g]["new_exp_required"])})}else{battle.add_exp(a.exp_animation[g]["exp_bonus"],a.exp_animation[g]["percent"])}c++},(d*2000))}}else{battle.add_exp(a.exp_bonus,a.exp_percent)}},600)}if(typeof a.monster_defeated!="undefined"){animate.process({img_width:520,animation:4,selector:"#monster_"+a.monster_defeated+"_sprite",time:1200,message:"Monster defeated"});$("#monster_"+a.monster_defeated+"_sprite_status .energy_condition div").stop(true);clearInterval(battle_data.monsters[a.monster_defeated]["attack"]);$("#monster_"+a.monster_defeated).fadeOut(1000,function(){$("#monster_"+a.monster_defeated+"_sprite_status").fadeOut(300)});$.each(battle_data.monsters,function(c){if(battle_data.monsters[c]["battle_monster_id"]==a.monster_defeated){clearInterval(battle_data.monsters[c]["attack"]);battle_data.monsters[c]=false;battle_data.total_monsters-=1}});var b="";$.each(battle_data.monsters,function(c){var d=battle_data.monsters[c];if(d!=false){b+='<a href="#" id="'+d.battle_monster_id+'">'+d.name+"</a>"}});$(".attack_choice").html(b)}if(typeof a.battle_won!="undefined"){animate.events.battle_won(a)}else{if(typeof a.battle_lost!="undefined"){animate.character.faint("#player_sprite")}else{animate.run_queue();animate.character.idle("#player_sprite")}}},battle_won:function(b){battle.hide_action_menu();clearTimeout(show_action_menu);setTimeout(function(){animate.character.cheer("#player_sprite");battle.sounds.play_sound("level_passed");if(battle.sounds_enabled==true){battle.battle_theme.fadeTo(10,200)}setTimeout(function(){animate.character.idle("#player_sprite");sit_down_idle=setTimeout(function(){animate.process({img_width:720,animation:5,selector:"#player_sprite",time:1200})},16000)},2500);setTimeout(function(){$("#continue_waves").animate({marginRight:0},1200).css({zIndex:9999});$("#retreat_waves").animate({marginLeft:0},1800).css({zIndex:9999})},1500);if(typeof b.jackpot_bonuses!="undefined"){battle.jackpot_bonuses(b.jackpot_bonuses)}},500);$("#wave_completed_number").text(battle_data.wave);var c=$("#wave_completed span");var a=0;c.each(function(d,e){setTimeout(function(){$(c[d]).animate({opacity:1},250,"linear");a++;if(c.length==a){setTimeout(function(){c.stop().animate({opacity:0},1000)},6000)}},parseInt(d)*150)});console.log("Level passed!")},battle_loss:function(){battle.hide_action_menu();animate.character.faint("#player_sprite");setTimeout(function(){popup.create({title:"You lost!",content:"The battle has been lost. Try stocking up on a ton of HP potions next time, the really help!",cancel_button:{label:"Back to dashboard",position:"right",callback:function(){redirect("world")}}})},2000)}},skills:{heal:function(c){var b="animation"+rand(1,1000000);var d=$(".player_container").offset();var a='<div id="front_portal_'+b+'"></div>';a+='<div id="back_portal_'+b+'"></div>';$("#animation_hive").append(a);$("#front_portal_"+b).css({position:"absolute",left:d.left-20,top:d.top-10,width:120,height:120,background:"transparent url(/images/animations/heal_portal_front.png)no-repeat 3px -40px",zIndex:14,opacity:0,});$("#back_portal_"+b).css({position:"absolute",left:d.left-20,top:d.top-10,width:120,height:120,background:"transparent url(/images/animations/heal_portal_back.png)no-repeat 3px -5px",zIndex:5,opacity:0,});setTimeout(function(){$("#back_portal_"+b).animate({opacity:1},300,function(){$("#front_portal_"+b).animate({opacity:1,top:"+=32"},600,function(){battle.increase_hp("#player_sprite",c.animate_data["amount"]);setTimeout(function(){$("#front_portal_"+b).animate({opacity:0,top:"-=30"},800,function(){$(this).remove();$("#back_portal_"+b).fadeOut(1000,function(){$(this).remove()})})},500)})})},300);animate.process({img_width:720,animation:4,selector:"#player_sprite",message:c.animate_data.description,time:1700,queue:true,callback:function(){animate.events.battle_checks(c)}})},burn:function(c){if(c.animate_data.miss==true){battle.missed_target("#monster_"+c.animate_data.target_id+"_sprite");$("#monster_"+c.animate_data.target_id+"_sprite").parent().animate({opacity:0.5},200,function(){$(this).animate({opacity:1},400)})}else{var b="animation"+rand(1,1000000);var d=$("#monster_"+c.animate_data.target_id+"_sprite").offset();var a='<div id="front_burn_'+b+'"></div>';a+='<div id="back_burn_'+b+'"></div>';$("#animation_hive").append(a);$("#front_burn_"+b).css({position:"absolute",left:d.left-20,top:d.top,width:120,height:120,background:"transparent url(/images/animations/burn.png)no-repeat -5px -40px",zIndex:14,opacity:0,});$("#back_burn_"+b).css({position:"absolute",left:d.left-20,top:d.top-10,width:120,height:120,background:"transparent url(/images/animations/burn_spectacles.gif)no-repeat -15px -5px",zIndex:5,opacity:0});setTimeout(function(){$("#back_burn_"+b).animate({opacity:0.6},400);battle.deplete_hp("#monster_"+c.animate_data.target_id+"_sprite",c.animate_data["amount"]);animate.coin_burst("#monster_"+c.animate_data.target_id+"_sprite",parseInt(c.animate_data.jackpot_bonus));$("#front_burn_"+b).animate({opacity:0.9,top:"+=13"},600,function(){$("#back_burn_"+b).animate({opacity:0},800);setTimeout(function(){$("#front_burn_"+b).animate({opacity:0},800,function(){$(this).remove()})},500)})},300)}animate.process({img_width:720,animation:3,selector:"#player_sprite",message:c.animate_data.description,time:1400,queue:true,callback:function(){animate.events.battle_checks(c)}})},slash:function(b){var a=find_distance("#player_sprite");animate.process({img_width:720,animation:0,selector:"#player_sprite",message:b.animate_data.description,time:400,queue:true,move_x:(a.x+55),callback:function(){if(b.animate_data.miss==true){battle.missed_target("#monster_"+b.animate_data.target_id+"_sprite");$("#monster_"+b.animate_data.target_id+"_sprite").parent().animate({opacity:0.5},200,function(){$(this).animate({opacity:1},400)})}else{battle.sounds.play_sound("rat_hit");setTimeout(function(){animate.coin_burst("#monster_"+b.animate_data.target_id+"_sprite",parseInt(b.animate_data.jackpot_bonus))},200);battle.deplete_hp("#monster_"+b.animate_data.target_id+"_sprite",b.animate_data["amount"]);if(b.animate_data.critical){battle.critical_target("#monster_"+b.animate_data.target_id+"_sprite")}}animate.process({img_width:550,animation:3,selector:"#player_sprite",time:800,callback:function(){$("#player_sprite").addClass("flip_div").parent().stop().css({left:function(){return(a.x+40)+"px"}});animate.process({animation:0,selector:"#player_sprite",time:250,move_x:a.x-15,callback:function(){$("#player_sprite").removeClass("flip_div").parent().stop().css({left:function(){return a.x+"px"}});animate.events.battle_checks(b)}})}})}})},},items:{hp_potion:function(a){setTimeout(function(){battle.increase_hp("#player_sprite",a.animate_data["amount"])},400);animate.process({img_width:720,animation:7,selector:"#player_sprite",message:a.animate_data.description,time:1000,queue:true,callback:function(){animate.events.battle_checks(a)}})},fruit_orange:function(a){this.hp_potion(a)},fire_bomb:function(e){var b=$("#misc_hive");var a=$("#player_sprite").offset();var f=$("#jackpot").offset();var c=0;b.append('<img src="/images/exp_orb_1.png" alt="" id="expjp_bomb" style="left:'+(parseInt(a.left)+25)+"; top:"+(parseInt(a.top)+60)+'; " class="flying_coin" />');var d={start:{x:(parseInt(a.left)+25),y:(parseInt(a.top)+60),angle:140,length:-0.3},end:{x:$("#battlefield").offset()["left"]+($("#battlefield").width()/1.4),y:$("#battlefield").offset()["top"]+($("#battlefield").height()/1.6),}};$("#expjp_bomb").animate({path:new $.path.bezier(d),opacity:1},700,function(){$(this).remove()});animate.process({img_width:720,animation:3,selector:"#player_sprite",message:e.animate_data.description,time:1600,queue:true,callback:function(){animate.events.battle_checks(e)}})},},};function test_run(){}setTimeout(function(){test_run()},1500);setInterval(function(){test_run()},5000);var log_events=false;var list_skill_id=0;var active_monster_key=false;var actions_binded=false;var show_action_menu;buzz.defaults.preload="auto";buzz.defaults.duration=5000;var battle={monster_structures:{},sounds_enabled:true,battle_theme:new buzz.sound(baseurl+"sounds/battle_bridge",{formats:["mp3","ogg"]}),process_json:function(a){battle.hide_action_menu();$("#player_sprite_status .energy_condition div").width(0).css("opacity",0.7);$("#player_sprite_status .energy_condition div").animate({width:"100%"},parseInt(a.waiting_time),"linear",function(){$(this).animate({opacity:1},200)});show_action_menu=setTimeout(function(){battle.show_action_menu()},(parseInt(a.waiting_time)+200));switch(a.response_type){case"animate":animate.skills[a.animate_data["animation_key"]](a);break;case"loss":break;case"win":break;case"item":animate.items[a.animate_data["animation_key"]](a);break;case"escape":break}},sounds:{cached:{},battle_bg:function(){if(battle.sounds_enabled){battle.battle_theme.setVolume(0).play().fadeTo(30,5000).loop()}},play_sound:function(a){if(battle.sounds_enabled){if(battle.sounds["cached"][a]===undefined){battle.sounds["cached"][a]=new buzz.sound(baseurl+"sounds/"+a,{formats:["mp3","ogg"]})}battle.sounds["cached"][a].play()}},},start_battle:function(){battle.sounds.battle_bg()},hide_action_menu:function(){actions_binded=false;$(".attack_choice a").die("click");$("#technique_list li a, #backpack_list li a").unbind("click");$("#battle_overview").fadeTo(200,1);$("#techniques_overview, #items_overview, #toggle_overview").animate({opacity:0.4});$("#cover_battle_overview_ui").show()},show_action_menu:function(){rebind_actions();$("#battle_overview").fadeTo(200,1);$("#techniques_overview, #items_overview, #toggle_overview").animate({opacity:1});$("#cover_battle_overview_ui").hide()},deplete_hp:function(e,c){var b=find_distance(e);var d="d"+rand(1,1000000);var a=$(e+"_status");$("#battlefield").append('<strong class="damage" id="'+d+'" style="opacity:0;">'+c+"</strong>");$("#"+d).css({left:b.x+25,top:b.y+10}).animate({opacity:1,fontSize:"22px"},100,"linear").animate({opacity:0,top:b.y-5,fontSize:"14px"},700,"linear");$(e).parent().children(".avatar_label").animate({opacity:1},200);$(e).parent().children(".health_bar").animate({opacity:1},200,function(){var f=$(e).parent().children(".health_bar");var h=parseInt(f.attr("data_current_hp"))-c;if(h<0){h=0}var g=percent(h,f.attr("data_total_hp"));f.attr("data_current_hp",h);f.children("div").animate({width:g+"%"},500);a.children(".health_condition").children("div").animate({width:g+"%"},500);if(g<15){a.children(".right").html('<b style="color:red">'+h+"</b>/"+f.attr("data_total_hp"))}else{a.children(".right").text(h+"/"+f.attr("data_total_hp"))}});setTimeout(function(){$(e).parent().children(".health_bar, .avatar_label").animate({opacity:0},600)},1800)},increase_hp:function(e,c){var b=find_distance(e);var d="d"+rand(1,1000000);var a=$(e+"_status");$("#battlefield").append('<strong class="healing_points" id="'+d+'" style="opacity:0;">+'+c+"</strong>");$("#"+d).css({left:b.x+25,top:b.y+10}).animate({opacity:1,fontSize:"22px"},100,"linear").animate({opacity:0,top:b.y-5,fontSize:"14px"},700,"linear");$(e).parent().children(".avatar_label").animate({opacity:1},200);$(e).parent().children(".health_bar").animate({opacity:1},200,function(){var f=$(e).parent().children(".health_bar");var h=parseInt(f.attr("data_current_hp"))+c;if(h>f.attr("data_total_hp")){h=f.attr("data_total_hp")}if(h<0){h=0}var g=percent(h,f.attr("data_total_hp"));f.attr("data_current_hp",h);f.children("div").animate({width:g+"%"},500);a.children(".health_condition").children("div").animate({width:g+"%"},500);if(g<15){a.children(".right").html('<b style="color:red">'+h+"</b>/"+f.attr("data_total_hp"))}else{a.children(".right").text(h+"/"+f.attr("data_total_hp"))}});setTimeout(function(){$(e).parent().children(".health_bar, .avatar_label").animate({opacity:0},600)},1800)},add_exp:function(a,d){var c="exp"+rand(1,1000000);$("#misc_hive").after('<strong class="exp_points" id="'+c+'" style="opacity:0;">+'+a+"</strong>");$(".progress_text #current_exp").increase(a);$(".experience_bar div").animate({width:d+"%"},1000);var b=$(".experience_bar").offset();$("#"+c).css({left:b.left+100,top:b.top-20,fontSize:"24px"});$("#"+c).animate({opacity:1,fontSize:"20px",top:"+=15"},300,"linear",function(){var e=$("#"+c);setTimeout(function(){e.animate({opacity:0},1000,"linear",function(){e.remove()})},3000)})},missed_target:function(c){var a=find_distance(c);var b="d"+rand(1,1000000);$("#battlefield").append('<strong class="missed_label" id="'+b+'" style="opacity:0; letter-spacing:1px;">Miss</strong>');$("#"+b).css({left:a.x+10,top:a.y+20}).animate({opacity:1,letterSpacing:0},350,"linear").animate({opacity:0,top:a.y-15},1200,"linear")},critical_target:function(c){var a=find_distance(c);var b="d"+rand(1,1000000);$("#battlefield").append('<strong class="critical_label" id="'+b+'" style="opacity:0;">Critical!</strong>');$("#"+b).css({left:a.x-10,top:a.y+35}).animate({opacity:1},200,"linear").animate({opacity:0},1000,"linear")},jackpot_bonuses:function(a){$("#jackpot_bonuses_rewards").html("");var b="",c=0;$.each(a,function(e,d){b+="<span>"+e+" (+"+d+' <img src="/images/coins.png" width="13" height="13" />)</span><br>';c+=d});$("#jackpot_bonuses_rewards").append(b);$("#jackpot_bonuses").animate({opacity:1,right:"-=10"},1000,function(){var f=$("#jackpot h3");var e=parseInt(f.attr("data_amount"));var g=0,d=0;setTimeout(function(){$("#jackpot_bonuses").animate({opacity:0,right:"+=10"},1000)},1500);if((e+c)>1000){while(d<=c){setTimeout(function(){f.text(number_format(g+e));g++},d*50);d++}f.attr("data_amount",d+e)}else{while(d<=c){setTimeout(function(){f.text(g+e);g++},d*50);f.attr("data_amount",d+e);d++}}})},structure:{clear:function(){$.each(battle_data.monsters,function(a,b){clearInterval(battle_data.monsters[a]["attack"]);$(".enemy_container, .monster_status").fadeOut(200,function(){$(this).remove()})});battle_data.monsters={};battle_data.total_monsters=0},initiate:function(){}},create_monsters:function(c){var b=500;var d="";var a={};$.each(c,function(f,e){$("#monster_status_tpl").mustache(e).prependTo("#monster_status_hive");$("#monster_sprite_tpl").mustache(e).appendTo("#monster_hive");$("#monster_"+e.id).fadeIn(200);animate.process({img_width:520,animation:0,selector:"#monster_"+e.battle_monster_id+"_sprite",time:1600,loop:true});if(typeof battle_data.monsters[f]==="undefined"){battle_data.monsters[f]={}}if(typeof a[e.animation_frame]==="undefined"){$.getScript("/global/js/battle_components/"+e.animation_frame+".js",function(g,h){battle_data.monsters[f]["attack"]=(function(){$.ajax({type:"POST",url:"/battle/monster_turn/",data:{monster:e.battle_monster_id},dataType:"json",success:function(i){battle.monster_structures[e.animation_frame][i.animate_data.animation_key](i,f,e);var j=$("#monster_"+e.battle_monster_id+"_sprite_status .energy_condition div");j.stop().width(0).css("opacity",0.7);j.animate({width:"100%"},(i.waiting_time-300),"linear",function(){$(this).animate({opacity:1},200)});battle_data.monsters[f]["attack_interval"]=setTimeout(function(){},i.waiting_time)},error:function(){console.log("Something went wrong! :(")}})})})}battle_data.monsters[f]=e;battle_data.monsters[f]["distance"]=find_distance("#monster_"+e.battle_monster_id+"_sprite");d+='<a href="#" id="'+e.battle_monster_id+'">'+e.name+"</a>";b+=1500});$(".attack_choice").html(d)}};var buzz_preferences={formats:["mp3","ogg"],preload:true,autoload:false,loop:false};function rebind_actions(){if(actions_binded==false){actions_binded=true;$(".attack_choice a").live("click",function(){var a={skill_id:list_skill_id,target_id:$(this).attr("id")};$(".attack_choice").hide(0);$.ajax({type:"POST",url:"/battle/use_skill/",data:a,cache:false,async:true,dataType:"json",success:function(b){battle.process_json(b)}});return false});$("#backpack_list li a").bind("click",function(a){this_obj=$(this);data_item_id=this_obj.attr("data_item_id");this_obj.find(".item_count").decrease(1);if(parseInt(this_obj.find(".item_count").attr("data_amount"))<1){this_obj.parent().fadeOut(200)}battle.sounds.play_sound("select");$("#toggle_overview").click();$.ajax({type:"POST",url:"/battle/use_item/",data:{item_id:data_item_id},dataType:"json",success:function(b){battle.process_json(b)}});a.preventDefault()});$("#technique_list li a").bind("click",function(a){this_obj=$(this);list_skill_id=this_obj.attr("data_skill_id");skill_target=this_obj.attr("data_target");battle.sounds.play_sound("select");switch(skill_target){case"monster":if(battle_data.total_monsters==1){if(active_monster_key===false){$.each(battle_data.monsters,function(c,d){if(typeof d=="object"){active_monster_key=c}})}var b={skill_id:list_skill_id,target_id:battle_data.monsters[active_monster_key]["battle_monster_id"]};$.ajax({type:"POST",url:"/battle/use_skill/",data:b,cache:false,async:true,dataType:"json",success:function(c){battle.process_json(c)}})}else{$(".attack_choice").fadeToggle(200)}break;case"character":var b={skill_id:list_skill_id,target_id:battle_data.my_character_id};$.ajax({type:"POST",url:"/battle/use_skill/",data:b,cache:false,async:true,dataType:"json",success:function(c){battle.process_json(c)}});break}a.preventDefault()})}}$(document).ready(function(){function b(){for(var c in buzz.sounds){buzz.sounds[c].mute()}local_db.set("remember_sound_toggle",true);battle.battle_theme.pause();battle.sounds_enabled=false;$("#sound").html('<span id="sound_icon" class="font_icon">></span> Play sounds')}function a(){for(var c in buzz.sounds){buzz.sounds[c].unmute()}local_db.set("remember_sound_toggle",false);battle.battle_theme.setVolume(0).play().fadeTo(30,5000).loop();battle.sounds_enabled=true;$("#sound").html('<span id="sound_icon" class="font_icon"><</span>&nbsp;&nbsp;Mute sounds')}if(Modernizr.localstorage){if(local_db.get("remember_sound_toggle")===true){b()}}$("#toggle_overview").toggle(function(){$("#techniques_overview").hide();$("#items_overview").show();$("#toggle_overview").html("&lsaquo; Back to skills");battle.sounds.play_sound("button_click")},function(){$("#techniques_overview").show();$("#items_overview").hide();$("#toggle_overview").html("View my items &rsaquo;");battle.sounds.play_sound("button_click")});$("#sound").bind("click",function(c){if(battle.sounds_enabled===true){b()}else{a()}c.preventDefault()});$(".attack_choice a").live("mouseover mouseout",function(c){if(c.type=="mouseover"){$(".enemy_container, .monster_status").css({opacity:"0.5"});$("#monster_"+$(this).attr("id")+" .avatar_label, #monster_"+$(this).attr("id")+" .health_bar, #monster_"+$(this).attr("id")+"_sprite_status").stop().animate({opacity:"1"},200);$("#monster_"+$(this).attr("id")).css({opacity:"1"})}else{$(".enemy_container, .monster_status").css({opacity:"1"});$(".enemy_container .avatar_label, .enemy_container .health_bar").stop().css({opacity:"0"},100)}});$("#start_battle_music").live("click",function(){battle.sounds.battle_bg();return false});$(".player_container").hover(function(){$(this).children(".health_bar, .avatar_label").stop().animate({opacity:1},200)},function(){$(this).children(".health_bar, .avatar_label").stop().animate({opacity:0},200)});$(".enemy_container").live("mouseover mouseout",function(c){if(c.type=="mouseover"){$(this).children(".health_bar, .avatar_label").stop().animate({opacity:1},200)}else{$(this).children(".health_bar, .avatar_label").stop().animate({opacity:0},200)}});$("#continue_waves").live("click",function(){clearTimeout(sit_down_idle);animate.character.idle("#player_sprite");if(battle_data.wave==1){$("#continue_waves").animate({marginRight:"-=300"},400);$("#retreat_waves").animate({marginLeft:"-=300"},600)}else{$("#continue_waves").animate({marginRight:"-=300"},200);$("#retreat_waves").animate({marginLeft:"-=300"},400)}$.getJSON(baseurl+"/battle/move_forward/",function(c){battle.structure.clear();battle.create_monsters(c.monsters);battle_data.total_monsters=c.total_monsters;battle_data.wave=c.wave;$("#wave_keys li.current_wave").removeClass("current_wave").addClass("completed_wave");$(".wave_badge").html("Wave #"+c.wave).attr("id","wave"+c.wave);$("#wave_keys li#wave"+c.wave).addClass("current_wave");$.each(battle_data.monsters,function(d,e){if(typeof e=="object"){active_monster_key=d}});setTimeout(function(){battle.show_action_menu()},500);$("#wave_completed span").animate({opacity:0},500)});return false});$("#retreat_waves").live("click",function(){animate.character.idle("#player_sprite");$("#continue_waves").animate({marginRight:"-=300"},400);$("#retreat_waves").animate({marginLeft:"-=300"},600);$.getJSON(baseurl+"/battle/leave_battles/",function(e){var c=0;var f=$("#my_gold"),d=$("#jackpot h3");while(c<e.jackpot_gold){setTimeout(function(){f.increase(1,true);d.decrease(1,true)},c*50);c++}setTimeout(function(){redirect("world")},(e.jackpot_gold*50)+100)});return false});battle.sounds["cached"]["punch"]=new buzz.sound(baseurl+"sounds/punch",buzz_preferences);battle.sounds["cached"]["button_click"]=new buzz.sound(baseurl+"sounds/button_click",buzz_preferences);battle.sounds["cached"]["level_passed"]=new buzz.sound(baseurl+"sounds/level_passed",buzz_preferences);battle.sounds["cached"]["rat_attack"]=new buzz.sound(baseurl+"sounds/rat_attack",buzz_preferences);battle.sounds["cached"]["rat_hit"]=new buzz.sound(baseurl+"sounds/rat_hit",buzz_preferences);battle.sounds["cached"]["select"]=new buzz.sound(baseurl+"sounds/select",buzz_preferences).setVolume(20)});